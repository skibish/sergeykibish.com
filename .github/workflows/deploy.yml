name: Deploy

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

env:
  BUNNYSYNC_SHA265: "54f0d28ff9ddabc9b453a9d0cacce747bd98ff0b96c5a6f4e86e21e685702e10"
  BUNNYSYNC_VERSION: "0.0.1"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: "0.119.0"
        extended: true

    - uses: actions/setup-node@v3
      with:
        node-version: "20"
        cache: "npm"

    - uses: actions/cache@v3
      with:
        path: resources
        key: ${{ runner.os }}-hugo-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-hugo

    - name: Build
      run: |
        npm install-clean
        hugo --gc --minify

    - name: Publish
      run: |
        set -e

        curl --silent \
            --location \
            --show-error \
            --output bunnysync \
            --url https://github.com/skibish/bunnysync/releases/download/${{ env.BUNNYSYNC_VERSION }}/bunnysync_${{ env.BUNNYSYNC_VERSION }}_linux_amd64

        echo "${{ env.BUNNYSYNC_SHA265 }} bunnysync" | sha256sum -c

        chmod +x bunnysync
        ./bunnysync -src ./public -storage-zone ${{ secrets.BUNNY_STORAGE }} -storage-api-key ${{ secrets.BUNNY_API_STORAGE }} | tee bunnysync.log

    - name: Refresh
      run: |
        set -e

        line_count=$(wc -l < bunnysync.log)

        if [ "$line_count" -eq 0 ]; then
          echo "Nothing to refresh"
          exit 0
        fi

        curl --silent \
            --show-error \
            --output /dev/null \
            --request POST \
            --url https://api.bunny.net/pullzone/${{ secrets.BUNNY_PULL_ZONE }}/purgeCache \
            --header 'AccessKey: ${{ secrets.BUNNY_API }}' \
            --header 'content-type: application/json'
